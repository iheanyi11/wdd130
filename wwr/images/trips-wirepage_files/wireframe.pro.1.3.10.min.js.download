var app={windowData:{height:$(window).height(),width:$(window).width()},activepage:{id:"1",type:"pages",position:{top:0},masterpageSelected:0,name:null},pages:{},pagesOrder:new Array,masterpagesOrder:$canvaswrap.attr("data-master-pages-order")?$canvaswrap.attr("data-master-pages-order").split(","):new Array,masterpages:{},getMasterPageName:function(e){if(e in this.masterpages)return this.masterpages[e].name},getPageObjById:function(e){var a;if(e in this.pages||e in this.masterpages)return(a={})[e]=this.pages[e]||this.masterpages[e],a},getChildObjById:function(e){var a;if(e in this.pages||e in this.masterpages)return(a={})[e]=this.pages[e]||this.masterpages[e],a},getThisObj:function(){return this.masterpages},getActivepageName:function(){var e=this.activepage.id;if(this[this.activepage.type]&&this[this.activepage.type][e])return this[this.activepage.type][e].name},ifMasterAppliedToActivepage:function(e){if(app.activepage.position.top)return this[this.activepage.type][this.activepage.id].masterPages&&this[this.activepage.type][this.activepage.id].masterPages.includes(e)},toggleActivepageVisibility:function(e,a,t,p){var s;t=t||this.activepage.id,void 0===p&&(p=!this.pages[t].hidden||!1),$.observable(app.pages[t]).setProperty({hidden:p}),$("#"+t).attr("data-hidden",p),this.pages[t].hasOwnProperty("children")&&(s=this,$.each(this.pages[t].children,function(e,a){s.toggleActivepageVisibility(null,null,a,p)}))},getShowBtnVis:function(){return this.pages[this.activepage.id].parent&&this.pages[this.pages[this.activepage.id].parent].hidden?1:0},handleMasterWithActivepage:function(e){this.ifMasterAppliedToActivepage(e)?this.removeMasterFromPage(e):this.applyMasterToPage(e)},applyMasterAttr:function(e){e=e||this.activepage.id;var a=this.pages[e].masterPages;(a=a.join()||!1)?$("#"+e).attr("data-applied-master",a):$("#"+e).removeAttr("data-applied-master")},applyMasterToPage:function(t,e,a){var p;e=e||this.activepage.id,this.pages[e].masterPages||(this.pages[e].masterPages=new Array),this.pages[e].masterPages.includes(t)||"false"==t||($.observable(app.pages[e].masterPages).insert(t),$.observable(app.pages[e]).setProperty("hasMaster",app.pages[e].hasMaster+1),this.applyMasterAttr(e),a&&void 0!==this.pages[e].children&&(p=this,$.each(this.pages[e].children,function(e,a){p.applyMasterToPage(t,a,!0)})),showMasterpage(e,t))},removeMasterFromPage:function(t,e,a){e=e||this.activepage.id,$.observable(app.pages[e].masterPages).remove(app.pages[e].masterPages.indexOf(t));var p,s=app.pages[e].masterPages,r=s.length;(s=s.join()||!1)?($("#"+e).attr("data-applied-master",s),$.observable(app.pages[e]).setProperty("hasMaster",r)):($("#"+e).removeAttr("data-applied-master"),$.observable(app.pages[e]).setProperty("hasMaster",0)),$("#"+e).removeAttr("data-m-pos-y-"+t+" data-m-pos-x-"+t),removeGuides($("#"+t+" > .wire")),a&&this.pages[e].hasOwnProperty("children")&&(p=this,$.each(this.pages[e].children,function(e,a){p.removeMasterFromPage(t,a,!0)}))},getContextMenuPos:function(){var e="pages"===app.activepage.type,a=e?216:148,a=this.activepage.position.top+a>this.windowData.height?this.windowData.height-a-(e?60:50):this.activepage.position.top-50;return a},getContextSubMenuPos:function(){var e=this.getContextMenuPos()+212+28*Object.keys(this.masterpages).length;return e>this.windowData.height?-(e-this.windowData.height+36):0},getMasterContextMenuPos:function(e){var a=this.activepage.contextMenuPos.y+206,t=this.activepage.contextMenuPos.x+232;return{x:t>this.windowData.width?this.activepage.contextMenuPos.x-(t-this.windowData.width+20):this.activepage.contextMenuPos.x,y:a>this.windowData.height?this.activepage.contextMenuPos.y-(a-this.windowData.height+20):this.activepage.contextMenuPos.y}},inArr:function(e,a){return-1!==$.inArray(e,a)},getPagesArr:function(){return this.pagesOrder},getSelMasterName:function(){if(this.activepage.masterpageSelected)return this.masterpages[this.activepage.masterpageSelected].name},showMasterContextMenu:function(e){app.activepage.contextMenuPos||$.observable(app.activepage).setProperty({contextMenuPos:{x:e.clientX-30,y:50}})},getAllPagesInOrder:function(){let p=[];return $.each(this.pagesOrder,function(e,a){!function t(e){p.push(e),app.getPageObjById(e)[e].children&&$.each(app.getPageObjById(e)[e].children,function(e,a){t(a)})}(a)}),p}},helpers={applyMasterToAll:function(){app.pages[app.activepage.id]||($.each(app.pages,function(e,a){a.id&&app.pages[a.id.toString()]&&-1==app.pages[a.id.toString()].masterPages.indexOf(app.activepage.id)&&app.applyMasterToPage(app.activepage.id,a.id.toString(),!1)}),helpers.hideContextMenu())},removeMasterFromAll:function(){app.pages[app.activepage.id]||($.each(app.pagesOrder,function(e,a){app.pages[a.toString()]&&0===app.pages[a.toString()].parent&&app.removeMasterFromPage(app.activepage.id,a.toString(),!0)}),helpers.hideContextMenu())},editSelMaster:function(){make_page_active(app.activepage.masterpageSelected,null,!0),$.observable(app.activepage).removeProperty("masterpageSelected")},deSelMaster:function(){deselectMaster()},addNewPage:function(e,a){var t,p,s,r;app.activepage.new||(a.stopPropagation(),t="masterpages"===e,a=parseInt(+new Date*Math.random()*100).toString(36).slice(-8),p=activepage.data("template"),s=t?"New masterpage"+cntm++:"New page"+cntp++,app.activepage.existingName=s,r=t&&$("#canvas .masterpage").length?$("#canvas .masterpage").last().attr("id"):app.pagesOrder[app.pagesOrder.length-1]||$(".page").last().attr("id"),$("#"+r).after($("<div>").addClass(function(){var e="page";return t&&(e+=" masterpage"),e}).attr({id:a,"data-pagename":s,"data-page-height":$canvaswrap.height(),"data-page-width":$canvaswrap.width(),"data-template":p,"data-hidden":!1,"data-orientation":$canvaswrap.attr("data-orientation")})),$.observable(app[e]).setProperty(a,{id:a,name:s,hidden:!1,parent:0,childrenCount:0,masterPages:[a],hasMaster:0,"page-height":$canvaswrap.height(),"page-width":$canvaswrap.width(),template:p,orientation:$canvaswrap.attr("data-orientation")}),$.observable(app.activepage).setProperty({type:e,id:a,new:1}),make_page_active(a),$("input#new-page").focus().select())},deletePage:function(){var e;1<$(".sitemap li").length?window.confirm("Are you sure that you want to delete this page? If it contains any nested pages, they will be removed as well.")&&(removePageById(app.activepage.id),e=$("#sitemaplist").find("li").eq(0).attr("data-pageid"),make_page_active(e)):alert("You can't delete the only page in the project")},deleteMasterPage:function(){var e;window.confirm("Are you sure that you want to delete this masterpage?")&&(helpers.removeMasterFromAll(),$.observable(app.masterpages).removeProperty(app.activepage.id),$.observable(app.masterpagesOrder).remove(app.masterpagesOrder.indexOf(app.activepage.id)),e=(e=app.masterpages)[Object.keys(e)[0]].id||app.pagesOrder[0],helpers.hideContextMenu(),make_page_active(e))},renamePage:function(){helpers.hideContextMenu(),$.observable(app.activepage).setProperty({editable:!0}),app.activepage.existingName=$(this).attr("title"),$("#sitemap-wrap").find("input[type=text]").select()},duplicatePage:function(){var e,a,t;app.activepage.new||(e=parseInt(+new Date*Math.random()*100).toString(36).slice(-8),-1!==(a=(marr=app.pages[app.activepage.id].masterPages.slice(0)).indexOf(app.activepage.id))&&(marr[a]=e),delete(a=$.extend({},app.pages[app.activepage.id],{id:e,masterPages:marr,name:app.pages[app.activepage.id].name+" Copy",childrenCount:0})).children,$.observable(app.pages).setProperty(e,a),(t=activepage.clone()).attr({id:e,"data-pagename":a.name,"data-applied-master":marr}),prevId=app.activepage.id,$("#"+prevId).after(t),$.observable(app.pagesOrder).insert(app.pagesOrder.indexOf(this.activepage.id)+1,e),this.pages[e].parent&&$.observable(app.pages[app.pages[app.activepage.id].parent].children).insert(app.pages[app.pages[app.activepage.id].parent].children.indexOf(app.activepage.id)+1,e),make_page_active(e,!1),$.observable(app.activepage.position).setProperty("top",0))},hideContextMenu:function(){$.observable(app.activepage.position).setProperty("top",0)},backToPrev:function(){activepage.add("#canvas > .master-on").find("[data-snap-mark-h] , [data-snap-mark-v]").removeAttr("data-snap-mark-h").removeAttr("data-snap-mark-v");var e=app.activepage.id;make_page_active(app.activepage.prevPage),selectMaster(null,e)},convertToMaster:function(){var e,a,p=app.activepage.id;app.pages[p]&&(e=app.pages[p],app.pages[p].parent&&(a=app.pages[p].parent,$.observable(app.pages[a].children).remove(app.pages[a].children.indexOf(p)),0===app.pages[a].children.length)&&$.observable(app.pages[a]).removeProperty("children"),app.pages[p].children&&app.pages[p].children.length&&($.each(app.pages[p].children,function(e,a){var t=(app.pages[a].parent=0)<=app.pagesOrder.indexOf(p)?app.pagesOrder.indexOf(p):app.pagesOrder.length;$.observable(app.pagesOrder).insert(t,a),$("#"+a).removeAttr("data-parent-id")}),delete e.children),e.parent=0,delete e.masterPages,$.observable(app.masterpages).setProperty(p,e),$.observable(app.pages).removeProperty(p),$.observable(app.activepage).setProperty("type","masterpages"),$.observable(app.pagesOrder).remove(app.pagesOrder.indexOf(p)),$.observable(app.masterpagesOrder).insert(p),helpers.hideContextMenu(),$("#"+p).removeAttr("data-parent-id").addClass("masterpage").off().insertAfter("#"+app.masterpagesOrder[app.masterpagesOrder.length-2]),$("#canvas .masterpage").hide(),make_page_active(p))},convertToRegular:function(e){var a,t=app.activepage.id;app.masterpages[t]&&((a=app.masterpages[t]).masterPages=[t],helpers.removeMasterFromAll(t),$.observable(app.pages).setProperty(t,a),$.observable(app.masterpages).removeProperty(t),$.observable(app.activepage).setProperty("type","pages"),$.observable(app.masterpagesOrder).remove(app.masterpagesOrder.indexOf(t)),$.observable(app.pagesOrder).insert(t),helpers.hideContextMenu(),$("#"+t).removeClass("masterpage master-o"))},applyAllMasterpagesToPage:function(e){e.stopPropagation(),$.each(app.masterpagesOrder,function(e,a){app.applyMasterToPage(a.toString(),app.activepage.id,0)}),helpers.refreshContextMenuMasterpagesList()},removeAllMasterpagesToPage:function(e){e.stopPropagation();e=app.pages[app.activepage.id].masterPages.slice(0);$.each(e,function(e,a){a&&a!==app.activepage.id&&app.removeMasterFromPage(a.toString(),app.activepage.id,0)}),helpers.refreshContextMenuMasterpagesList()},refreshContextMenuMasterpagesList:function(){var e=app.activepage.position.top;$.observable(app.activepage.position).setProperty("top",0),$.observable(app.activepage.position).setProperty("top",e)},arrangeMaster:function(e){var a,t=app.pages[app.activepage.id].masterPages.indexOf(app.activepage.masterpageSelected),p=app.activepage.masterpageSelected;switch(e){case"0":a=0;break;case"1":case"-1":a=t+parseInt(e);break;default:a=app.activepage.masterpageSelected.length}$.observable(app.pages[app.activepage.id].masterPages).move(t,a),make_page_active(app.activepage.id,!1,!1,1),app.applyMasterAttr(app.activepage.id),helpers.hideMasterContextMenu(),selectMaster(null,p)},hideMasterContextMenu:function(){$.observable(app.activepage).removeProperty("contextMenuPos")},changePageType:function(e,a){$("#sitemap-wrap").attr("data-pagetype",e),blueSitemapInput()}},cntp=1,cntm=1;app.getContextMenuPos.depends=["activepage.position.top","windowData.height"],app.getMasterContextMenuPos.depends=["activepage.contextMenuPos","windowData.height",,"windowData.width"],app.getSelMasterName.depends=["activepage.masterpageSelected"],app.getContextSubMenuPos.depends=["activepage.position.top","masterpages","windowData.height"],app.ifMasterAppliedToActivepage.depends=["activepage.position.top","pages"],app.getPageObjById.depends=["pages"],app.getActivepageName.depends=["activepage.id","activepage.type","activepage.name"],app.getShowBtnVis.depends=["activepage.id","pagesOrder"],$.link(!0,$("#pagenametop"),app);


!function(n,l,d,r){var o=function(){var t=d.createElement("div"),e=d.documentElement;if(!("pointerEvents"in t.style))return!1;t.style.pointerEvents="auto",t.style.pointerEvents="x",e.appendChild(t);var s=l.getComputedStyle&&"auto"===l.getComputedStyle(t,"").pointerEvents;return e.removeChild(t),!!s}(),s={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",fillClass:"dd-filler",noDragClass:"dd-nodrag",emptyClass:"dd-empty",parentClass:"dd-parent",expandBtnHTML:'<button data-action="expand" type="button">x</button>',collapseBtnHTML:'<button data-action="collapse" type="button">x</button>',group:0,maxDepth:16,threshold:1},p=n("#sitemaplist");function i(t,e){this.w=n(d),this.el=n(t),this.options=n.extend({},s,e),this.init()}i.prototype={init:function(){var s=this;s.reset(),s.el.data("nestable-group",this.options.group),s.placeEl=n('<div class="'+s.options.placeClass+'"/>'),s.fillEl=n('<li class="'+s.options.fillClass+'"/>'),n.each(this.el.find(s.options.itemNodeName),function(t,e){s.setParent(n(e))}),s.el.delegate("button","click",function(t){var e;t.stopPropagation(),t.preventDefault(),s.dragEl||(t=(e=n(t.target)).data("action"),e=e.parent(s.options.itemNodeName),"collapse"===t&&s.collapseItem(e),"expand"===t&&s.expandItem(e))});var i,a,l,o=!1;p.bind("mousedown",function(t){3!==t.which&&(liDropped=!(o=!(i=!1)),a=t.clientY,l=t.clientX)}),p.bind("mousemove",function(t){var e=Math.round(Math.sqrt(Math.pow(a-t.clientY,2)+Math.pow(l-t.clientX,2)));!o||previewMode||e<5||(i||function(t){var e=n(t.target);if(!e.hasClass(s.options.handleClass)){if(e.closest("."+s.options.noDragClass).length)return;e=e.closest("."+s.options.handleClass)}e.length&&!s.dragEl&&(s.isTouch=/^touch/.test(t.type),s.isTouch&&1!==t.touches.length||(t.preventDefault(),s.dragStart(t.touches?t.touches[0]:t)))}(t),i=!0,t=t,s.dragEl&&(t.preventDefault(),s.dragMove(t.touches?t.touches[0]:t)))}),p.add(".overlay,.pane-t .addpage-wrap, .sitemap, .pane-b .addpage-wrap, .slide-right #top").bind("mouseup",function(t){var e=i;i=!1,e||liDropped?(e=t,s.dragEl&&(e.preventDefault(),s.dragStop(e.touches?e.touches[0]:e))):(t.stopPropagation(),(t=t).stopPropagation(),n(t.target).is("button, .hidepage, .more-page-actions, .overlay, input, #context-menu-overlay, ol")||liDropped||(t=n(t.target).parent()).is("li")&&t.data("pageid")!=app.activepage.id&&make_page_active(t.data("pageid"))),o=!1})},serialize:function(){var a=this;return step=function(t,s){var i=[];return t.children(a.options.itemNodeName).each(function(){var t=n(this),e=n.extend({},t.data()),t=t.children(a.options.listNodeName);t.length&&(e.children=step(t,s+1)),i.push(e)}),i},step(a.el.find(a.options.listNodeName).first(),0)},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null,this.data={}},expandItem:function(t){t.removeClass(this.options.collapsedClass),n("#"+t.attr("data-pageid")).removeClass("tree-collapsed"),t.children('[data-action="expand"]').hide(),t.children('[data-action="collapse"]').show(),t.children(this.options.listNodeName).show()},collapseItem:function(t){t.children(this.options.listNodeName).length&&(t.addClass(this.options.collapsedClass),n("#"+t.attr("data-pageid")).addClass("tree-collapsed"),t.children('[data-action="collapse"]').hide(),t.children('[data-action="expand"]').show(),t.children(this.options.listNodeName).hide())},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(n(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(n(this))})},setParent:function(t){t.children(this.options.listNodeName).length&&(t.find("button").length||(t.prepend(n(this.options.expandBtnHTML)),t.prepend(n(this.options.collapseBtnHTML))),t.addClass(this.options.parentClass)),t.children('[data-action="expand"]').hide()},unsetParent:function(t){t.removeClass(this.options.collapsedClass).removeClass(this.options.parentClass),t.children("[data-action]").remove(),t.children(this.options.listNodeName).remove()},dragStart:function(t){var e=this.mouse,s=n(t.target),i=s.closest(this.options.itemNodeName);i.parents(".dd-parent").addClass("li-sorting"),this.fillEl.css({height:i.height()}).html(i.html()),i.hasClass(this.options.parentClass)?this.fillEl.addClass(this.options.parentClass):this.fillEl.removeClass(this.options.parentClass),i.hasClass(this.options.collapsedClass)?this.fillEl.addClass(this.options.collapsedClass):this.fillEl.removeClass(this.options.collapsedClass),this.placeEl.css("height",0).hide(),e.offsetX=t.offsetX!==r?t.offsetX:t.pageX-s.offset().left,e.offsetY=t.offsetY!==r?t.offsetY:t.pageY-s.offset().top,e.startX=e.lastX=t.pageX,e.startY=e.lastY=t.pageY,this.dragRootEl=this.el,this.dragEl=n(d.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",i.width()),i.after(this.fillEl),i.after(this.placeEl),i[0].parentNode.removeChild(i[0]),i.appendTo(this.dragEl),n(d.body).append(this.dragEl),this.dragEl.css({left:t.pageX-e.offsetX,top:t.pageY-e.offsetY});for(var a,l=this.dragEl.find(this.options.itemNodeName),o=0;o<l.length;o++)(a=n(l[o]).parents(this.options.listNodeName).length)>this.dragDepth&&(this.dragDepth=a)},dragStop:function(t){this.el.find(".li-sorting").removeClass("li-sorting");var e=this.data,s=this.dragEl.children(this.options.itemNodeName).first();n("#sitemaplist .li-highlight").removeClass("li-highlight"),this.lastHoveredLi=null,a&&a.data("hidden")&&(s.attr("data-hidden",!0),n("#"+s.data("pageid")).attr("data-hidden",!0)),this.hasNewRoot,1!=p.find("ol:empty").length||this.revert||(this.unsetParent(n("#sitemaplist ol:empty").parent()),this.fillEl.parent("ol").remove());var i=n("#sitemaplist li").index(s);0<i&&n("#sitemaplist li").eq(i-1).data("pageid");if(this.append){if(!this.pointEl)return void(this.append=!1);var a=this.pointEl.parent("li"),i=this.options,l=a.attr("data-pageid");list=a.find(i.listNodeName).last(),depth=this.placeEl.parents(i.listNodeName).length,depth+this.dragDepth<=i.maxDepth&&setNewParent(s.data("pageid"),a.attr("data-pageid")),this.append=!1}else{l=this.placeEl.parents("li").first().attr("data-pageid")||0;setNewParent(s.data("pageid"),l,e)}this.fillEl.remove(),this.placeEl.remove(),this.dragEl.remove(),this.reset(),n.isEmptyObject(e)||movePage(s.data("pageid"),e)},dragMove:function(t){var e=this.options,s=this.mouse;this.revert=!1,this.dragEl.css({left:t.pageX-s.offsetX,top:t.pageY-s.offsetY}),s.lastX=s.nowX,s.lastY=s.nowY,s.nowX=t.pageX,s.nowY=t.pageY,s.distX=s.nowX-s.lastX,s.distY=s.nowY-s.lastY,s.lastDirX=s.dirX,s.lastDirY=s.dirY,s.dirX=0===s.distX?0:0<s.distX?1:-1,s.dirY=0===s.distY?0:0<s.distY?1:-1;var i=Math.abs(s.distX)>Math.abs(s.distY)?1:0;if(!s.moving)return s.dirAx=i,void(s.moving=!0);s.dirAx!==i?(s.distAxX=0,s.distAxY=0):(s.distAxX+=Math.abs(s.distX),0!==s.dirX&&s.dirX!==s.lastDirX&&(s.distAxX=0),s.distAxY+=Math.abs(s.distY),0!==s.dirY&&s.dirY!==s.lastDirY&&(s.distAxY=0)),s.dirAx=i;if(o||(this.dragEl[0].style.visibility="hidden"),this.pointEl=n(d.elementFromPoint(t.pageX-d.body.scrollLeft,t.pageY-(l.pageYOffset||d.documentElement.scrollTop))),o||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(e.emptyClass)||this.pointEl.length){i=this.pointEl.closest("."+e.rootClass),this.dragRootEl.data("nestable-id"),i.data("nestable-id");if(this.pointEl.hasClass(e.handleClass))this.lastHoveredLi=this.pointEl.parent("li"),this.pointEl.parent("li").find("."+e.fillClass).length||(this.pointEl.parent("li").is("li")&&!this.pointEl.parents(".dd-filler").length?(this.pointEl.addClass("li-highlight"),this.placeEl.hide()):(this.placeEl.show(),n("#sitemaplist .li-highlight").removeClass("li-highlight")),(a=this.pointEl.parent("li")).hasClass(e.collapsedClass)?this.append=!1:(this.append=!0,a.addClass("li-highlight")));else if(this.pointEl.hasClass(e.fillClass))this.placeEl.hide();else if(this.append=!1,n("#sitemaplist .li-highlight").removeClass("li-highlight"),this.pointEl.is("li")&&(this.lastHoveredLi=this.pointEl),this.lastHoveredLi&&!this.lastHoveredLi.parents(".dd-filler").length){var a=t.pageY<this.lastHoveredLi.offset().top+this.lastHoveredLi.height()/2&&s.distY<0,s=t.pageY>this.lastHoveredLi.offset().top+this.lastHoveredLi.height()/2&&0<s.distY;this.placeEl.parent();if(this.lastHoveredLi.hasClass(e.fillClass)&&(!this.lastHoveredLi.siblings("li").length||this.fillEl.is(":last-child")))return this.placeEl.hide(),void(this.revert=!0);a&&!this.lastHoveredLi.prev(":visible").hasClass(e.fillClass)?(this.lastHoveredLi.before(this.placeEl),this.placeEl.show(),this.data={ref:this.lastHoveredLi.attr("data-pageid"),after:0}):s&&!this.lastHoveredLi.next(":visible").hasClass(e.fillClass)?(this.lastHoveredLi.after(this.placeEl),this.placeEl.show(),this.data={ref:this.lastHoveredLi.attr("data-pageid"),after:1}):(s||a)&&this.placeEl.hide()}}}},n.fn.nestable=function(e){var s=this;return this.each(function(){var t=n(this).data("nestable");t?"string"==typeof e&&"function"==typeof t[e]&&(s=t[e]()):(n(this).data("nestable",new i(this,e)),n(this).data("nestable-id",(new Date).getTime()))}),s||this}}(window.jQuery||window.Zepto,window,document);var liDropped=!1;function setNewParent(t,e,s){if(liDropped=1,t){var i=app.pages[t].parent;if(0!==i&&($.observable(app.pages[i].children).remove(app.pages[i].children.indexOf(t),1),0===app.pages[i].children.length&&$.observable(app.pages[i]).removeProperty("children")),0===e)$.observable(app.pages[t]).setProperty("parent",0),0===i?reorderPages(t,e,s):$.observable(app.pagesOrder).insert(app.pagesOrder.indexOf(s.ref.toString())+s.after,t),$("#"+t).removeAttr("data-parent-id");else{$("#"+t).attr("data-parent-id",e),app.pages[t].parent=e,app.pages[e].hidden&&app.toggleActivepageVisibility(null,null,t,!0);var a=0;if(app.pages[e].children){if(s)if(s.ref===e)a=app.pages[e].children.length||0;else{if($.isEmptyObject(s)){a=$("[data-pageid="+e+"] > ol li").index($(".dd-filler"));return void $.observable(app.pages[e].children).insert(a,t.toString())}(a=app.pages[e].children.indexOf(s.ref.toString())+s.after)<0&&(a=0)}else a=app.pages[e].children.length||0;$.observable(app.pages[e].children).insert(a,t.toString())}else $.observable(app.pages[e]).setProperty("children",[t]);0===i&&$.observable(app.pagesOrder).remove(app.pagesOrder.indexOf(t))}}}function abortReordering(){var t=app.pagesOrder.slice().reverse().reverse();$.observable(app.pagesOrder).refresh([]).refresh(t)}function reorderPages(t,e,s){$.isEmptyObject(s)?abortReordering():((t=app.pagesOrder.indexOf(t.toString()))<(s=app.pagesOrder.indexOf(s.ref.toString())+s.after)&&--s,t!=s?($.observable(app.pagesOrder).move(t,s,1),$.map(app.pagesOrder,function(t,e){return app.pages[t].name})):abortReordering())}$("#collapse-expand").on("click",function(t){var e=$(t.target),t=e.data("action");"expand-all"===t&&$(".sitemap").nestable("expandAll"),"collapse-all"===t&&$(".sitemap").nestable("collapseAll"),e.hide().siblings().show()});
var pagesContextMenuTmpl,w,liArr,pLiArr,pagelist=$("#sitemaplist"),$masterpagelist=$("#masterpages-list"),masterTools=$("#mastertools"),pageTools=$("#pagetools"),$body=$("body"),pageListTmpl=$.templates("#pageListTmpl"),masterpageLiTmpl=$.templates("#masterpageLiTmpl");function insert_page(a,e,t){a=escapeHtml(a);var p=parseInt(+new Date*Math.random()*100).toString(36).slice(-8),r=activepage.data("template");$("#canvas").append($("<div>").addClass("page").attr({id:p,"data-pagename":a,"data-page-height":$canvaswrap.height(),"data-page-width":$canvaswrap.width(),"data-template":r,"data-hidden":"false"}))}function removePageById(a){var e;a&&(e=app.pages[a].parent,$("#"+a).remove(),$canvas.find("[data-link="+a+"]").removeAttr("data-link"),app.pages[a].children&&$.each(app.pages[a].children,function(a,e){removePageById(e)}),$.observable(app.pagesOrder).remove(app.pagesOrder.indexOf(a.toString())),e&&(1<app.pages[e].children.length?$.observable(app.pages[e].children).remove(app.pages[e].children.indexOf(a.toString())):$.observable(app.pages[e]).removeProperty("children")),$.observable(app.pages).removeProperty(a),$.observable(app.activepage.position).setProperty("top",0))}function removeAppliedMaster(p,a){a.each(function(a){if("all"===p)return $(this).removeAttr("data-applied-master"),!1;var e=(e=$(this).attr("data-applied-master")).split(","),t=$.inArray(p,e);-1<t&&(e.splice(t,1),$(this).attr("data-applied-master",e.toString())),e.length||pagelist.find("[data-pageid="+$(this).attr("id")+"] > .dd-handle").removeAttr("data-master-indicator")})}function applyMasterIndicator(a,e){var t,a=$("[data-pageid="+a+"]").find(".master-indicator").show();t=void 0===a.attr("data-hint")?[]:(t=a.attr("data-hint")).split(","),-1===$.inArray(e,t)&&t.push(e),a.attr("data-hint",t.toString())}function make_page_active(t,a,e,p,r){var i,s,n,d,o;activepage.add("#canvas > .masterpage").find("[data-snap-mark-h] , [data-snap-mark-v]").removeAttr("data-snap-mark-h").removeAttr("data-snap-mark-v"),t&&(deselectMaster(),$("#"+app.activepage.id).removeClass("active"),e?$.observable(app.activepage).setProperty("prevPage",app.activepage.id):$.observable(app.activepage).removeProperty("prevPage"),app.activepage.editable&&t!==app.activepage.id&&$.observable(app.activepage).removeProperty("editable"),$(".masterpage.ui-draggable").draggable("destroy"),removeGuides(activepage.find(" > .wire, > .w-group")),removeGuides($("#canvas > .master-on").find(" > .wire")),quill&&blurRTE(),e=app.masterpages[t]?"masterpages":"pages",$.observable(app.activepage).setProperty({id:t,type:e}),deselectAll(),activepage.hide(),(activepage=$("#"+t)).show().addClass("active").siblings(".page").hide(),"masterpages"==e&&($(".masterpage.ui-draggable").draggable("destroy"),activepage.removeClass("master-on").css({top:"0",left:"0"})),wirepanel.hide(),e=activepage.attr("data-page-width")||$canvaswrap.width(),i=activepage.attr("data-page-height")||$canvaswrap.height(),n=activepage.hasClass("masterpage")?"none":activepage.attr("data-template"),s=activepage.hasClass("masterpage")?"false":activepage.attr("data-orientation"),applyTemplate(n,s),$canvaswrap.css({width:e+"px",height:i+"px"}),(e=parseInt($canvaswrap.width(),10)+250)<$(window).width()&&(e=$(window).width()),supercanvas.css({width:e+"px",height:parseInt(i,10)+750+"px"}),cwidth=e,$("#canvas").show(),updateCanvasInput(e,i),$canvaswrap.center(),previewMode?(pLiArr.indexOf(t)==pLiArr.length-1?$("#next").addClass("inactive"):$("#next").removeClass("inactive"),0==pLiArr.indexOf(t)?$("#prev").addClass("inactive"):$("#prev").removeClass("inactive")):(computeGuides(activepage.find(" > .wire, > .w-group")),computeGuides("canvas"),useboxer()),a&&$.observable(app.activepage.position).setProperty({top:a,id:t}),void 0!==activepage.attr("data-applied-master")&&activepage.attr("data-applied-master").split(","),app.pages[t]&&($canvas.find(".masterpage").removeClass("master-on"),n=app.pages[t].masterPages.slice(0),(d=n.splice(n.indexOf(t))).shift(),o=n,$.each(o.reverse(),function(a,e){a=0<a?o[a-1]:t;$("#"+e).insertBefore($("#"+a)),showMasterpage(t,e)}),$.each(d,function(a,e){a=0<a?d[a-1]:t;$("#"+e).insertAfter($("#"+a)),showMasterpage(t,e)})),computeGuides(),makeShareUrl())}function blueSitemapInput(){app.activepage.new&&$.observable(app[app.activepage.type+"Order"]).insert(app.activepage.id),""===app[app.activepage.type][app.activepage.id].name&&$.observable(app[app.activepage.type][app.activepage.id]).setProperty("name",app.activepage.existingName||"Page"),app.activepage.existingName=!1,$.observable(app.activepage).removeProperty("editable").removeProperty("new")}function showMasterpage(a,e){$("#"+e).addClass("master-on").show().css({top:$("#"+a).attr("data-m-pos-y-"+e)?$("#"+a).attr("data-m-pos-y-"+e)+"px":"0",left:$("#"+a).attr("data-m-pos-x-"+e)?$("#"+a).attr("data-m-pos-x-"+e)+"px":"0",width:$("#"+e).attr("data-page-width"),height:$("#"+e).attr("data-page-height")}).find(".wire").draggable("destroy").resizable("destroy").off().end().data("masterId",e)}function selectMaster(a,e,t){$guidesHV.hide();e=e||$(a).parents(".master-on").attr("id");$canvas.data("drawing-in-progress")||($canvas.find(".master-on.ui-draggable").length||($.observable(app.activepage).setProperty("masterpageSelected",e),deselectAll()),$canvaswrap.data("master-dragged",!0).addClass("master-selected"),activepage.add("#canvas > .master-on").find("[data-snap-mark-h] , [data-snap-mark-v]").removeAttr("data-snap-mark-h").removeAttr("data-snap-mark-v"),$("#"+e).hasClass("ui-draggable"))||$("#"+e).draggable({snap:"#canvas",snapTolerance:10,start:function(a,e){$canvaswrap.addClass("draggingInProgress"),$.observable(app.activepage).removeProperty("contextMenuPos")},stop:function(a,e){var t="data-m-pos-x-"+$(this).data("masterId"),p="data-m-pos-y-"+$(this).data("masterId"),r={};r[t]=e.position.left,r[p]=e.position.top,activepage.attr(r),computeGuides($(this).find(" > .wire")),$canvaswrap.removeClass("draggingInProgress")}}).on("click",function(){$.observable(app.activepage).removeProperty("contextMenuPos")})}function deselectMaster(){$canvas.find(".master-on.ui-draggable").draggable("destroy").off(),$canvaswrap.data("master-dragged",!1).removeClass("master-selected"),$.observable(app.activepage).removeProperty("masterpageSelected").removeProperty("contextMenuPos")}function getPagesOrder(t){var a=$("#sitemaplist");return 0==$canvas.find(".page").not(".masterpage").length&&$canvas.find(".masterpage").length&&(a=$("#masterpages-list")),liArr=a.find(".dd-item").toArray(),pLiArr=$.map(liArr,function(a,e){if("true"!==liArr[e].dataset.hidden||t)return liArr[e].dataset.pageid})}function findFirstVisiblePage(){app.pagesOrder[0];for(var a,e=0;e<pLiArr.length;e++)if(!app.pages[pLiArr[e]].hidden){a=pLiArr[e];break}return a}function findNextVisiblePage(a){var e,t=app.activepage.id||app.pagesOrder[0],p=pLiArr.slice(0);a&&p.reverse();for(var r=p.indexOf(t)+1;r<p.length;r++)if(!app.pages[p[r]].hidden){e=p[r];break}return e}function movePage(a,e){a=a.toString();var t=$canvas.find("#"+a),p=$();app.pages[a].children&&!function t(a){$.each(app.pages[a].children,function(a,e){p=p.add($canvas.find("#"+e)),app.pages[e].children&&t(e)})}(a),t=t.add(p),-1===(previPgId=e.ref||-1)?$canvas.find(".page").first().is("#"+a)||$canvas.find(".page").first().before(t):e.after?$canvas.find("#"+previPgId).after(t):$canvas.find("#"+previPgId).before(t)}function setLiParent(a,e){$canvas.find("#"+a).attr("data-parent-id",e)}multipaged?(pagelist.empty(),$("#canvas .page").each(function(a){var e=$(this),t=(e[0].hasAttribute("data-hidden")||e.attr("data-hidden",0),e.attr("data-parent-id")||0),p=("0"===t&&(t=0),e.attr("id").toString()),r=(e[0].hasAttribute("data-applied-master")?((i=e.attr("data-applied-master").split(",")).includes(p)||i.unshift(p),-1!==(r=i.indexOf("false"))&&(i.splice(r,1),(mAttrF=i.join()||!1)?$("#"+p).attr("data-applied-master",mAttrF):$("#"+p).removeAttr("data-applied-master"))):i=[p],e.hasClass("masterpage")),i=(r||0!==t||app.pagesOrder.push(p),{id:p,name:e.attr("data-pagename"),hidden:"true"==e.attr("data-hidden"),parent:t,masterPages:i,hasMaster:i.length,"page-height":e.attr("data-page-height")||$canvaswrap.height(),"page-width":e.attr("data-page-width")||$canvaswrap.width(),template:e.attr("data-template"),orientation:e.attr("data-orientation")||"false"}),s=(t&&0!==t&&"0"!==t&&(t in app.pages||(app.pages[t]={}),app.pages[t].children=app.pages[t].children||new Array,app.pages[t].children.push(p)),s=r?"masterpages":"pages",p in app.pages?$.extend(app[s][p],i):app[s][p]=i,0!=t?pagelist.find("[data-pageid="+t+"]"):pagelist);r&&(s=$masterpagelist),0==t||s.find("ol").length||s.addClass("dd-parent").append("<ol>").addClass("dd-list"),0!=t&&(s=s.find("ol").first()),e.data("hidden")&&previewMode}),masterpageLiTmpl.link("#masterpagelist-wrap",app),pageListTmpl.link(pagelist,app),$("#sitemap-wrap").on("click",".more-actions",function(a){a.stopPropagation();var a=$(this).parents("li").attr("data-pageid"),e=void 0!==app.pages[a]?"pages":"masterpages";$.observable(app.activepage).setProperty({type:e,id:a,"position.top":$(this).offset().top}),make_page_active(a,$(this).offset().top)}).on("contextmenu",".dd-handle",function(a){a.preventDefault(),a.stopPropagation();var a=$(this).parents("li").attr("data-pageid"),e=void 0!==app.pages[a]?"pages":"masterpages";$.observable(app.activepage).setProperty({type:e,id:a,"position.top":$(this).offset().top})}),(pagesContextMenuTmpl=$.templates("#pagesContextMenuTmpl")).link("#pagesContextMenu-wrap",app,helpers),$.templates("#pagenameTmpl").link("#pagenametop",app,helpers),previewMode&&!pagelist.find("li").length&&pagelist.append("No published pages."),$(".sitemap").nestable(),previewMode&&pagelist.find(".dd-parent").each(function(a,e){$(e).find("> ol li:not([data-hidden=true])").length||$(e).removeClass("dd-parent").find(" > ol, button").remove()}),pagelist.find(".tree-collapsed button[data-action=collapse]").click()):((w=parseInt($canvaswrap.width(),10)+250)<$(window).width()&&(w=$(window).width()),supercanvas.css({width:w+"px",height:parseInt($canvaswrap.height(),10)+750+"px"})),$("#context-menu-overlay").on("click contextmenu",function(a){a.stopPropagation(),a.preventDefault(),$.observable(app.activepage.position).setProperty({top:0})}),$(".pagelist-btn").bind("click",function(){$("body").toggleClass("show-sitemap")}),$(".delete-page").click(function(){}),$("#masterpagelist-wrap").on("click","li",function(a){var e;$(a.target).hasClass("more-actions")||(e=$(a.target).parents("li").attr("data-pageid"),$(a.target).is("input"))||$(a.target).is(".overlay")||app.activepage.id==e||make_page_active(e)}),window.addEventListener("resize",$.throttle(800,function(){$.observable(app.windowData).setProperty({height:$(this).height(),width:$(this).width()})})),$("#sitemap-wrap").on("click","li.li-activepage .dd-handle",function(a){$.observable(app.activepage).setProperty({editable:!0}),app.activepage.existingName=$(this).attr("title"),$("#sitemap-wrap").find("input[type=text]").select()}).on("keydown","input[type=text]",function(a){13!==a.keyCode&&27!==a.keyCode||blueSitemapInput()}).on("click","ol .overlay",function(a){blueSitemapInput()}),$("#mastertools, #addpagebtn, #addmasterpagebtn, #delete-master-page, .has-helper").link(!0,app,helpers),$("#delete-master-page").on("click",helpers.deleteMasterPage),$.observable(app.pages).observeAll(function(a,e){e&&"name"==e.path&&($("#"+app.activepage.id).attr("data-pagename",e.value),$.observable(app.activepage).setProperty("name",e.value)),e&&"hasMaster"==e.path&&make_page_active(app.activepage.id)}),$.observable(app.masterpages).observeAll(function(a,e){"name"==e.path&&($("#"+app.activepage.id).attr("data-pagename",e.value),$.observable(app.activepage).setProperty("name",e.value))}),$.observable(app.masterpagesOrder).observeAll(function(a,e){var t=app.masterpagesOrder;(t=t.join()||!1)?$canvaswrap.attr("data-master-pages-order",t):$canvaswrap.removeAttr("data-master-pages-order")}),$("#masterpages-context-menu").on("click","li",function(a){a.stopPropagation()}),$(".pane-b").on("contextmenu",function(a){a.preventDefault()}),previewMode||$canvaswrap.on("mouseup",".master-on",function(a){draggingInProgress||previewMode||selectMaster(a.target,null,a)}).on("contextmenu",".master-on",function(a){$guidesHV.hide(),$.observable(app.activepage).setProperty({contextMenuPos:{x:a.clientX,y:a.clientY},masterpageSelected:$(a.target).attr("id")})}).on("dblclick",".master-on",function(a){$.observable(app.activepage).removeProperty("masterpageSelected"),$canvaswrap.removeClass("master-selected"),make_page_active($(a.target).attr("id"),null,!0)}),$.templates("#selectedMasterToolbarTmpl").link("#selected-master-toolbar",app,helpers),$("#next").click(function(){var a=findNextVisiblePage();a.length&&make_page_active(a)}),$("#prev").click(function(){var a=findNextVisiblePage(1);a&&make_page_active(a)}),pLiArr=getPagesOrder(),multipaged||(make_page_active("#canvas"),supercanvas.css({height:$(this).height(),width:$(this).width()})),$.link(!0,"#sel-master-page",app);
// https://github.com/farzher/fuzzysort v2.0.0
((r,e)=>{"function"==typeof define&&define.t?define([],e):"object"==typeof module&&module.exports?module.exports=e():r.fuzzysort=e()})(this,r=>{var i,o,e,a,f=r=>{var e=v(r="string"!=typeof r?"":r);return{target:r,i:e.o,v:e.u,l:N,g:e._,score:N,p:[0],obj:N}},n=r=>{r=(r="string"!=typeof r?"":r).trim();var e=v(r),a=[];if(e.h)for(var f,n=r.split(/\s+/),n=[...new Set(n)],t=0;t<n.length;t++)""!==n[t]&&(f=v(n[t]),a.push({u:f.u,o:n[t].toLowerCase(),h:!1}));return{u:e.u,_:e._,h:e.h,o:e.o,j:a}},M=r=>{if(999<r.length)return f(r);var e=t.get(r);return void 0!==e||(e=f(r),t.set(r,e)),e},q=r=>{if(999<r.length)return n(r);var e=s.get(r);return void 0!==e||(e=n(r),s.set(r,e)),e},D=(r,e)=>{if(r.h)return j(r,e);for(var a=r.o,f=r.u,n=f[0],t=e.v,i=f.length,o=t.length,v=0,s=0,u=0;;){if(n===t[s]){if(C[u++]=s,++v===i)break;n=f[v]}if(o<=++s)return N}var v=0,l=!1,g=0,d=e.l,c=(d===N&&(d=e.l=k(e.target)),s=0===C[0]?0:d[C[0]-1],0);if(s!==o)for(;;)if(o<=s){if(v<=0)break;if(200<++c)break;--v;s=d[L[--g]]}else if(f[v]===t[s]){if(L[g++]=s,++v===i){l=!0;break}++s}else s=d[s];var w=e.i.indexOf(a,C[0]),r=~w;if(r&&!l)for(var _=0;_<u;++_)C[_]=w+_;a=!1;r&&(a=e.l[w-1]===w);p=l?(b=L,g):(b=C,u);for(var b,p,x=0,h=0,_=1;_<i;++_)b[_]-b[_-1]!=1&&(x-=b[_],++h);if(x-=(12+(b[i-1]-b[0]-(i-1)))*h,0!==b[0]&&(x-=10*b[0]),l){for(var y=1,_=d[0];_<o;_=d[_])++y;24<y&&(x*=10*(y-24))}else x*=1e3;r&&(x/=10),a&&(x/=10),e.score=x-=o-i;for(_=0;_<p;++_)e.p[_]=b[_];return e.p.k=p,e},j=(r,e)=>{for(var a=new Set,f=0,n=N,t=0,i=r.j,o=0;o<i.length;++o){var v=i[o];if((n=D(v,e))===N)return N;f+=n.score,n.p[0]<t&&(f-=t-n.p[0]);for(var t=n.p[0],s=0;s<n.p.k;++s)a.add(n.p[s])}n.score=f;var u,o=0;for(u of a)n.p[o++]=u;return n.p.k=o,n},v=r=>{for(var e=r.length,a=r.toLowerCase(),f=[],n=0,t=!1,i=0;i<e;++i){var o=f[i]=a.charCodeAt(i);32===o?t=!0:n|=1<<(97<=o&&o<=122?o-97:48<=o&&o<=57?26:o<=127?30:31)}return{u:f,_:n,h:t,o:a}},k=r=>{for(var e=r.length,a=(r=>{for(var e=r.length,a=[],f=0,n=!1,t=!1,i=0;i<e;++i){var o=r.charCodeAt(i),v=65<=o&&o<=90,o=v||97<=o&&o<=122||48<=o&&o<=57,s=v&&!n||!t||!o,n=v,t=o;s&&(a[f++]=i)}return a})(r),f=[],n=a[0],t=0,i=0;i<e;++i)i<n?f[i]=n:(n=a[++t],f[i]=void 0===n?e:n);return f},t=new Map,s=new Map,C=[],L=[],E=r=>{for(var e=J,a=r.length,f=0;f<a;++f){var n=r[f];n!==N&&(e<(n=n.score)&&(e=n))}return e===J?N:e},F=(r,e)=>{var a=r[e];if(void 0!==a)return a;for(var f=e,n=(f=Array.isArray(e)?f:e.split(".")).length,t=-1;r&&++t<n;)r=r[f[t]];return r},G=r=>"object"==typeof r,H=1/0,J=-H,K=[],N=(K.total=0,null),O=(i=[],o=0,a=r=>{for(var e=i[n=0],a=1;a<o;){var f=a+1,n=a;f<o&&i[f].score<i[a].score&&(n=f),i[n-1>>1]=i[n],a=1+(n<<1)}for(var t=n-1>>1;0<n&&e.score<i[t].score;t=(n=t)-1>>1)i[n]=i[t];i[n]=e},(e={}).add=r=>{var e=o;i[o++]=r;for(var a=e-1>>1;0<e&&r.score<i[a].score;a=(e=a)-1>>1)i[e]=i[a];i[e]=r},e.C=r=>{var e;if(0!==o)return e=i[0],i[0]=i[--o],a(),e},e.L=r=>{if(0!==o)return i[0]},e.S=r=>{i[0]=r,a()},e);return{single:(r,e)=>{if("farzher"==r)return{target:"farzher was here (^-^*)/",score:0,p:[0]};if(!r||!e)return N;var r=q(r),a=(G(e)||(e=M(e)),r._);return(a&e.g)!==a?N:D(r,e)},go:(r,e,a)=>{if("farzher"==r)return[{target:"farzher was here (^-^*)/",score:0,p:[0],obj:e?e[0]:N}];if(!r)if(a&&a.all){var f=e;var n=a;var t=[],i=(t.total=f.length,n&&n.limit||H);if(n&&n.key)for(var o=0;o<f.length;o++){var v=f[o];var s=F(v,n.key);if(!s)continue;if(!G(s))s=M(s);s.score=J;s.p.k=0;var u=s;u={target:u.target,i:"",v:N,l:N,g:0,score:s.score,p:N,obj:v};t.push(u);if(t.length>=i)return t}else if(n&&n.keys)for(o=0;o<f.length;o++){v=f[o];var l=new Array(n.keys.length);for(var g=n.keys.length-1;g>=0;--g){s=F(v,n.keys[g]);if(!s){l[g]=N;continue}if(!G(s))s=M(s);s.score=J;s.p.k=0;l[g]=s}l.obj=v;l.score=J;t.push(l);if(t.length>=i)return t}else for(o=0;o<f.length;o++){s=f[o];if(!s)continue;if(!G(s))s=M(s);s.score=J;s.p.k=0;t.push(s);if(t.length>=i)return t}return t;return}else return K;var d=q(r),c=d._,w=(d.h,a&&a.threshold||J),_=a&&a.limit||H,b=0,p=0,x=e.length;if(a&&a.key)for(var h=a.key,y=0;y<x;++y){var j=e[y];!(m=F(j,h))||(c&(m=G(m)?m:M(m)).g)!==c||(B=D(d,m))===N||B.score<w||(B={target:B.target,i:"",v:N,l:N,g:0,score:B.score,p:B.p,obj:j},b<_?(O.add(B),++b):(++p,B.score>O.L().score&&O.S(B)))}else if(a&&a.keys)for(var k=a.scoreFn||E,C=a.keys,L=C.length,y=0;y<x;++y){for(var j=e[y],S=new Array(L),z=0;z<L;++z){h=C[z];(m=F(j,h))?(c&(m=G(m)?m:M(m)).g)!==c?S[z]=N:S[z]=D(d,m):S[z]=N}S.obj=j;var A=k(S);A===N||A<w||(S.score=A,b<_?(O.add(S),++b):(++p,A>O.L().score&&O.S(S)))}else for(var m,B,y=0;y<x;++y)!(m=e[y])||(c&(m=G(m)?m:M(m)).g)!==c||(B=D(d,m))===N||B.score<w||(b<_?(O.add(B),++b):(++p,B.score>O.L().score&&O.S(B)));if(0===b)return K;for(var I=new Array(b),y=b-1;0<=y;--y)I[y]=O.C();return I.total=b+p,I},highlight:(r,e,a)=>{if("function"==typeof e){var f=e;if((l=r)===N)return N;for(var n=l.target,t=n.length,i=(i=l.p).slice(0,i.k).sort((r,e)=>r-e),o="",v=0,s=0,u=!1,l=[],g=0;g<t;++g){var d=n[g];if(i[s]===g){if(++s,u||(u=!0,l.push(o),o=""),s===i.length){o+=d,l.push(f(o,v++)),o="",l.push(n.substr(g+1));break}}else u&&(u=!1,l.push(f(o,v++)),o="");o+=d}return l}if(r===N)return N;void 0===e&&(e="<b>"),void 0===a&&(a="</b>");for(var c="",w=0,_=!1,b=r.target,p=b.length,x=(x=r.p).slice(0,x.k).sort((r,e)=>r-e),h=0;h<p;++h){var y=b[h];if(x[w]===h){if(_||(_=!0,c+=e),++w===x.length){c+=y+a+b.substr(h+1);break}}else _&&(_=!1,c+=a);c+=y}return c},prepare:f,indexes:r=>r.p.slice(0,r.p.k).sort((r,e)=>r-e),cleanup:()=>{t.clear(),s.clear(),C=[],L=[]}}});
let $linkpanel=$("#link-pages-wrap");function renderLinksPanel(){$.observable(app).setProperty("linkText",""),$("body").removeClass("show-device-skin-popup top-dd-active"),getLinkFromSelecedElem(),$("body").toggleClass("show-links-panel"),wirepanel.hide(),$(".wcc-toolbar").hide();var e=1===activepage.find(".selected, .edited-text").length?activepage.find(".selected, .edited-text"):$("#selection-transformator");e.length&&($("#link-search").val(""),$("#link-pages-wrap li").show().find(".linklist-li-hovered").removeClass("linklist-li-hovered"),$("#link-pages-wrap .no-res").hide(),window.linklistLiIndex=-1,$("#link-search").focus(),positionLinksPanel())}function getLinkFromSelecedElem(){let e,i,n;var t;quill?(e=(t=quill.hasFocus())||quill.selection.savedRange.length?quill.selection.savedRange.index:0,i=t||quill.selection.savedRange.length?quill.selection.savedRange.length:quill.getLength(),(t=quill.getFormat(e,i)).wcclink&&(n={page:!0,value:t.wcclink}),t.weblink&&(n={web:!0,value:t.weblink}),$("#wcc-toolbar-instance").removeAttr("data-tooltip-show").hide()):(activepage.find(".selected, .g-selected").attr("data-link")&&(n={page:!0,value:activepage.find(".selected, .g-selected").attr("data-link")}),activepage.find(".selected, .g-selected").attr("data-weblink")&&(n={web:!0,value:activepage.find(".selected, .g-selected").attr("data-weblink")})),$.observable(app).setProperty({selectedLink:n})}function positionLinksPanel(){var e=1===activepage.find(".selected, .edited-text").length?activepage.find(".selected, .edited-text"):$("#selection-transformator");if(0==e.length)return!1;var i=$("#wcc-link-panel"),n=156<e.position().left+e.width()/2+$canvas.offset().left?e.position().left+e.width()/2+$canvas.offset().left:156,t=(n+156>window.innerWidth&&(n=window.innerWidth-184),e.position().top+e.height()+$canvas.offset().top+16);(t=t<48?e.position().top+$canvas.offset().top+e.height()+20:t)+i.height()>window.innerHeight&&(t=window.innerHeight-16-i.height()),$("#wcc-link-panel").css({top:t,left:n})}app.linkText="",app.selected=!1,$.views.converters("spaceToDash",function(e){return e.replace(/\s+/g,"-")}),$.views.converters("cleandomain",function(e){return e.replace(/^https?:\/\//,"")}),$.views.helpers({linksFilter:function(e,i,n){var t=app.getPageObjById(e)[e].name.toLowerCase(),l=app.linkText;return window.linklistLiIndex=-1,app.getPageObjById(e)[e].id!==app.activepage.id&&(!l||fuzzysort.single(l.toLowerCase(),t))},highlighteName:function(e){return fuzzysort.highlight(fuzzysort.single(app.linkText,e),"<b>","</b>")},addPageLink:function(e){},isUrl:function(e){return isDomain(e)}}),$.views.helpers.linksFilter.depends=["linkText","activepage.id"],$.views.helpers.highlighteName.depends=["linkText"],app.getAllPagesInOrder.depends=["pages.**^children","pagesOrder"],$.views.helpers.isUrl.depends=["linkText"];var pageLinksTmpl=$.templates("#pageLinksTmpl"),navigateLinksList=(pageLinksTmpl.link($linkpanel,app,{handleLinksPanelUpdate:function(e,i,n){getLinkFromSelecedElem(),positionLinksPanel()},handleLinkTextClear:function(){$.observable(app).setProperty("linkText",""),$("#link-search").focus()},handleApplyingWebLink:function(){var e;quill?(quillHandler(!1,"wcclink"),quillHandler(app.linkText,"weblink"),$("#wcc-toolbar-instance").show().find(".ql-wcclink").addClass("ql-active")):(app.unlinkElement(),activepage.find(".selected, .g-selected").not(".w-group-member").attr("data-weblink",(e=app.linkText,/^https?:\/\//i.test(e)?e:"https://"+e))),hideLinksPanel(),deselectAll(),$.observable(app).setProperty({selectedLink:app.linkText})},handleApplyingPageLink:function(e){quill?(quillHandler(!1,"weblink"),quillHandler(e,"wcclink"),$("#wcc-toolbar-instance").show().find(".ql-wcclink").addClass("ql-active")):(e&&app.unlinkElement(),activepage.find(".selected, .g-selected").not(".w-group-member").attr("data-link",e)),hideLinksPanel(),deselectAll()},getCurrentLinkTarget:function(){},handlePageUnlink:function(e){app.unlinkElement(e),deselectAll()},handleSearchInputFocus:function(){}}),app.unlinkElement=function(e){e&&e.stopPropagation(),quill?(quillHandler(!1,"wcclink"),quillHandler(!1,"weblink"),$("#wcc-toolbar-instance").show()):(activepage.find(".selected, .g-selected").removeAttr("data-link").removeAttr("data-weblink"),activepage.find(".selected, .g-selected").parent("a").length&&activepage.find(".selected, .g-selected").unwrap()),$.observable(app).setProperty({selectedLink:{}})},window.linklistLiIndex=-1,function(e){linklistLiIndex+=e;var e=$("#link-pages-wrap li div"),i=((linklistLiIndex=linklistLiIndex>=e.length?0:linklistLiIndex)<0&&(linklistLiIndex=e.length-1),"linklist-li-hovered");e.removeClass(i).eq(linklistLiIndex).addClass(i),e.eq(linklistLiIndex)[0]&&e.eq(linklistLiIndex)[0].scrollIntoView(!1)});function hideLinksPanel(){$("body").removeClass("show-links-panel")}$("#link-pages-wrap").data("lastCursorPos",{x:0,y:0}),$("#link-pages-wrap").on("mouseenter","li div",function(e){let i=e.screenX,n=e.screenY;var t,l;i==$("#link-pages-wrap").data("lastCursorPos").x&&n==$("#link-pages-wrap").data("lastCursorPos").y||($("#link-pages-wrap").data("lastCursorPos",{x:e.screenX,y:e.screenY}),e=$(e.target).parent(),t="linklist-li-hovered",e=(l=$("#link-pages-wrap li")).index(e),l.find("div").removeClass(t).end().eq(e).find(" > div").addClass(t),window.linklistLiIndex=e)}),$("body").on("keydown","#link-search",function(e){if(13==e.keyCode)return $.views.helpers.isUrl(app.linkText)?($(".linklist-li-hovered").trigger("click"),$(".linklist-li-selected, linklist-li-hovered").trigger("applyWebLink")):$(".linklist-li-hovered").trigger("click"),!1;40==e.keyCode&&(e.preventDefault(),navigateLinksList(1)),38==e.keyCode&&(e.preventDefault(),navigateLinksList(-1))});const withHttp=e=>/^https?:\/\//i.test(e)?e:"https://"+e;function activateWebLinks(){$canvas.find("[data-weblink]").each(function(e,i){var i=$(i),n=withHttp(i.attr("data-weblink"));i.parents(".page").append($("<a>").attr({href:n,target:"_blank",rel:"noopener noreferrer"}).addClass("wcc-preview-link").css({height:i.height(),width:i.width(),top:i.position().top+(i.parents(".wire").length&&i.parents(".wire").position().top),left:i.position().left+(i.parents(".wire").length&&i.parents(".wire").position().left)}))})}function deactivateWebLinks(){$canvas.find(".wcc-preview-link").remove()}